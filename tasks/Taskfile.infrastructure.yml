version: '3'

vars:
  DOCKER_COMPOSE_FILE: docker-compose.yml
  N8N_PORT: 5678
  N8N_URL: http://localhost:{{.N8N_PORT}}

tasks:
  setup:
    desc: "Complete setup: build, start services, and configure"
    cmds:
      - docker-compose build
      - docker-compose up -d
      - task: wait-for-services
      - task: configure-n8n
      - echo "✅ Setup complete! N8N available at {{.N8N_URL}}"

  start:
    desc: "Start all services"
    cmds:
      - docker-compose up -d
      - task: wait-for-services
      - echo "🚀 Services started"

  stop:
    desc: "Stop all services"
    cmds:
      - docker-compose down
      - echo "⏹️ Services stopped"

  restart:
    desc: "Restart all services"
    cmds:
      - task: stop
      - task: start

  status:
    desc: "Show service status"
    cmds:
      - docker-compose ps

  wait-for-services:
    desc: "Wait for services to be ready"
    internal: true
    cmds:
      - >
        echo "⏳ Waiting for services..."
        && timeout 60s bash -c 'until curl -f {{.N8N_URL}}/healthz >/dev/null 2>&1; do sleep 2; done'
        && echo "✅ Services ready!"
